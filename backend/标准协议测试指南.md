# MCP Server 标准协议测试指南

测试版本: v0.5.1 (标准协议修复)
测试日期: 2025-12-28

---

## 1. 启动后端服务

```bash
cd /Users/zhaojl/Development/Projects/Synapse/backend
.venv/bin/uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

服务启动后应该看到：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

---

## 2. 基础验证测试

### 2.1 检查 MCP Server 列表

```bash
curl -s http://localhost:8000/api/v1/mcp-servers | python3 -m json.tool
```

### 2.2 创建测试 MCP Server（如果列表为空）

```bash
curl -X POST http://localhost:8000/api/v1/mcp-servers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Synapse Test Server",
    "prefix": "synapse",
    "description": "测试 MCP Server，符合标准协议",
    "combination_ids": [1]
  }' | python3 -m json.tool
```

### 2.3 获取标准配置

```bash
curl -s http://localhost:8000/mcp/synapse/config | python3 -m json.tool
```

**预期输出**：
```json
{
  "config": {
    "synapse": {
      "url": "http://localhost:8000/mcp/synapse"
    }
  },
  "note": "这是一个标准的远程 MCP Server，支持 HTTP + SSE 传输（单一端点同时支持 GET 和 POST）",
  "endpoint": "http://localhost:8000/mcp/synapse",
  "important": [
    "单一端点同时处理 GET（SSE流）和 POST（JSON-RPC请求）",
    "初始化时服务器会返回 Mcp-Session-Id 头",
    "后续请求需要在头部携带此 Session ID",
    ...
  ]
}
```

✅ **验证点**：
- 只有一个 `url` 字段（不是两个端点）
- `endpoint` 字段显示单一端点
- `important` 数组说明了协议要求

---

## 3. 标准 MCP 协议测试

### 3.1 初始化请求（获取 Session ID）

```bash
curl -i -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {}
    }
  }'
```

**预期响应**：

**响应头应包含**：
```
HTTP/1.1 200 OK
Content-Type: application/json
Mcp-Session-Id: 550e8400-e29b-41d4-a716-446655440000
MCP-Protocol-Version: 2024-11-05
```

**响应体**：
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {
        "listChanged": true
      }
    },
    "serverInfo": {
      "name": "Synapse Test Server",
      "version": "0.4.0"
    }
  }
}
```

✅ **验证点**：
- 响应头包含 `Mcp-Session-Id`（UUID 格式）
- 响应头包含 `MCP-Protocol-Version`
- 能力声明包含 `listChanged: true`
- **保存 Session ID 用于后续测试！**

---

### 3.2 使用 Session ID 获取工具列表

**将上一步获取的 Session ID 填入下面的命令：**

```bash
SESSION_ID="<从上一步响应头中复制>"

curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/list",
    "params": {}
  }' | python3 -m json.tool
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "tools": [
      {
        "name": "synapse_get_pet_petId",
        "description": "Find pet by ID",
        "inputSchema": {...}
      },
      {
        "name": "synapse_get_user_username",
        "description": "Get user by user name",
        "inputSchema": {...}
      }
    ]
  }
}
```

✅ **验证点**：
- 使用 Session ID 可以正常请求
- 返回工具列表
- 工具名称带 prefix 前缀

---

### 3.3 测试缺少 Session ID 的错误处理

```bash
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/list",
    "params": {}
  }' | python3 -m json.tool
```

**预期响应**：
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32600,
    "message": "Missing Mcp-Session-Id header"
  },
  "id": 3
}
```

✅ **验证点**：
- 正确拒绝缺少 Session ID 的请求
- 返回标准的 JSON-RPC 错误

---

## 4. SSE 流测试

### 4.1 使用 Session ID 打开 SSE 流

**使用之前获取的 Session ID：**

```bash
curl -N http://localhost:8000/mcp/synapse \
  -H "Accept: text/event-stream" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -H "MCP-Protocol-Version: 2024-11-05"
```

**预期输出**（持续流）：
```
event: endpoint
data: {"jsonrpc":"2.0","method":"endpoint","params":{"endpoint":"/mcp/synapse"}}

event: ping
data: {"type":"ping"}

event: ping
data: {"type":"ping"}

...
```

✅ **验证点**：
- 连接成功建立
- 收到 `endpoint` 事件
- 每30秒收到 `ping` 事件

**保持这个终端运行，不要关闭！**

---

### 4.2 测试实时通知（新开终端2）

在 SSE 连接保持运行的情况下，执行：

```bash
# 切换状态触发通知
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=inactive"
```

**回到终端 1（SSE 流）**，应该立即看到：
```
event: message
data: {"jsonrpc":"2.0","method":"notifications/tools/list_changed"}
```

再次切换回 active：
```bash
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=active"
```

终端 1 应该再次收到通知。

✅ **验证点**：
- 配置变更时 SSE 客户端立即收到通知
- 通知格式为标准 JSON-RPC 通知
- 方法名为 `notifications/tools/list_changed`

---

### 4.3 测试 SSE 流（不使用 Session ID）

```bash
# 新开终端 3，不提供 Session ID
curl -N http://localhost:8000/mcp/synapse \
  -H "Accept: text/event-stream" \
  -H "MCP-Protocol-Version: 2024-11-05"
```

**预期行为**：
- 服务器自动创建新会话
- 返回 SSE 流
- 响应头包含新的 `Mcp-Session-Id`

✅ **验证点**：
- GET 请求可以不带 Session ID（会自动创建）
- 返回的 Session ID 与之前的不同（新会话）

---

## 5. 完整协议流程测试

### 测试脚本

创建文件 `test_mcp_protocol.sh`：

```bash
#!/bin/bash

echo "=== MCP 标准协议测试 ==="
echo

# 1. 初始化并获取 Session ID
echo "步骤 1: 初始化（获取 Session ID）"
INIT_RESPONSE=$(curl -s -i -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {}
    }
  }')

# 提取 Session ID
SESSION_ID=$(echo "$INIT_RESPONSE" | grep -i "Mcp-Session-Id:" | awk '{print $2}' | tr -d '\r')
echo "Session ID: $SESSION_ID"
echo

# 2. 使用 Session ID 获取工具列表
echo "步骤 2: 获取工具列表"
curl -s -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/list",
    "params": {}
  }' | python3 -m json.tool
echo

# 3. 测试 SSE 流（后台运行）
echo "步骤 3: 打开 SSE 流（5秒）"
curl -N http://localhost:8000/mcp/synapse \
  -H "Accept: text/event-stream" \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -H "MCP-Protocol-Version: 2024-11-05" &
SSE_PID=$!
sleep 5
kill $SSE_PID 2>/dev/null
echo

echo "=== 测试完成 ==="
```

运行测试：
```bash
chmod +x test_mcp_protocol.sh
./test_mcp_protocol.sh
```

---

## 6. Claude Desktop 客户端测试

### 6.1 配置 Claude Desktop

**配置文件位置**：
- macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
- Windows: `%APPDATA%\Claude\claude_desktop_config.json`

**编辑配置文件**：
```bash
# macOS
code ~/Library/Application\ Support/Claude/claude_desktop_config.json
# 或
nano ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

**添加配置**：
```json
{
  "mcpServers": {
    "synapse": {
      "url": "http://localhost:8000/mcp/synapse"
    }
  }
}
```

### 6.2 重启 Claude Desktop

1. **完全退出** Claude Desktop（不是最小化）
   - macOS: Cmd+Q
   - Windows: 右键托盘图标 → 退出

2. **重新启动** Claude Desktop

### 6.3 验证连接

**方法 1: 查看后端日志**
后端终端应该显示：
```
INFO:     127.0.0.1:xxx - "POST /mcp/synapse HTTP/1.1" 200 OK
```

**方法 2: 在 Claude 中测试**
在 Claude 对话中发送：
```
请列出你可用的工具
```

应该看到以 `synapse_` 开头的工具。

### 6.4 测试实时通知

1. **保持 Claude Desktop 打开**

2. **在后台更新配置**：
```bash
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=inactive"
sleep 2
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=active"
```

3. **在 Claude 中验证**：
```
请刷新并列出你的工具
```

工具列表应该反映最新的配置状态。

---

## 7. Cursor 客户端测试（可选）

### 7.1 配置 Cursor

1. 打开 Cursor
2. Settings → MCP Servers
3. 添加配置：
   ```json
   {
     "url": "http://localhost:8000/mcp/synapse"
   }
   ```

### 7.2 测试连接

在 Cursor AI 面板中测试工具是否加载。

---

## 8. 故障排查

### 问题 1: Session ID 未返回

**检查**：
```bash
curl -i -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{}}}' \
  | grep -i "mcp-session-id"
```

应该输出：
```
Mcp-Session-Id: <UUID>
```

### 问题 2: 后续请求失败

**检查**：
```bash
# 确认 Session ID 格式正确
echo $SESSION_ID

# 确认请求包含正确的头
curl -v -X POST http://localhost:8000/mcp/synapse \
  -H "Mcp-Session-Id: $SESSION_ID" \
  -H "MCP-Protocol-Version: 2024-11-05" \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}'
```

### 问题 3: SSE 连接无响应

**检查**：
```bash
# 确认服务正在运行
lsof -i:8000

# 确认 MCP Server 状态为 active
curl -s http://localhost:8000/api/v1/mcp-servers | python3 -m json.tool

# 测试基础 SSE 连接
curl -N http://localhost:8000/mcp/synapse \
  -H "Accept: text/event-stream" \
  -H "MCP-Protocol-Version: 2024-11-05"
```

### 问题 4: Claude Desktop 无法连接

**检查清单**：

1. ✅ 后端服务正在运行
2. ✅ 配置文件路径正确
3. ✅ 配置格式正确（只有 `url` 字段）
4. ✅ 完全重启了 Claude Desktop
5. ✅ MCP Server 状态为 `active`

**查看 Claude Desktop 日志**：
```bash
# macOS
tail -f ~/Library/Logs/Claude/main.log
```

---

## 9. 关键验证清单

测试完成后，请确认以下所有项目：

### 协议头

- [ ] 初始化响应包含 `Mcp-Session-Id` 头
- [ ] 所有响应包含 `MCP-Protocol-Version` 头
- [ ] 后续请求需要携带 Session ID

### 端点行为

- [ ] 单一端点 `/mcp/{prefix}` 支持 GET 和 POST
- [ ] GET 返回 SSE 流
- [ ] POST 处理 JSON-RPC 请求
- [ ] 缺少 Session ID 的请求被拒绝（initialize 除外）

### 会话管理

- [ ] 初始化时创建新会话
- [ ] Session ID 格式为 UUID
- [ ] GET 请求可以复用会话
- [ ] 无效 Session ID 被拒绝

### SSE 流

- [ ] SSE 连接成功建立
- [ ] 收到 `endpoint` 事件
- [ ] 定期收到 `ping` 事件
- [ ] 配置变更时收到 `message` 事件

### 配置格式

- [ ] `/mcp/{prefix}/config` 返回单一 `url` 字段
- [ ] 不包含分开的 `sse` 字段
- [ ] `important` 数组解释了协议要求

### 客户端测试

- [ ] Claude Desktop 能够连接（如果可测试）
- [ ] Cursor 能够连接（如果可测试）
- [ ] 工具列表正确显示
- [ ] 实时通知正常工作

---

## 10. 测试完成后

如果所有测试通过：

1. ✅ 查看修复报告：`MCP_STANDARD_FIX_REPORT.md`
2. ✅ 确认符合标准 MCP 协议
3. ✅ 决定是否提交到 git

如果测试失败：

1. 查看故障排查部分
2. 检查后端日志
3. 报告具体的错误信息

---

**测试指南版本**: v0.5.1 (标准协议修复)
**创建日期**: 2025-12-28
