# MCP Server 测试指南

## 1. 启动后端服务

```bash
cd /Users/zhaojl/Development/Projects/Synapse/backend
.venv/bin/uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

服务启动后应该看到：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

---

## 2. 基础测试（新开一个终端）

### 2.1 检查 MCP Server 列表
```bash
curl -s http://localhost:8000/api/v1/mcp-servers | python3 -m json.tool
```

### 2.2 创建测试 MCP Server（如果没有）
```bash
curl -X POST http://localhost:8000/api/v1/mcp-servers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Synapse Test Server",
    "prefix": "synapse",
    "description": "测试 MCP Server，支持 HTTP + SSE 传输",
    "combination_ids": [1]
  }' | python3 -m json.tool
```

### 2.3 获取 MCP 配置
```bash
curl -s http://localhost:8000/mcp/synapse/config | python3 -m json.tool
```

应该看到包含 `url` 和 `sse` 两个端点的配置。

---

## 3. 测试 SSE 连接

### 终端 1：建立 SSE 连接（保持运行）
```bash
curl -N http://localhost:8000/mcp/synapse/sse
```

应该立即看到：
```
event: connected
data: {"session_id": "...", "prefix": "synapse", "server": "Synapse Test Server"}
```

**保持这个终端运行，不要关闭！**

---

## 4. 测试实时通知（新开终端 2）

在 SSE 连接保持运行的情况下，执行：

```bash
# 切换状态触发通知
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=inactive"
```

**回到终端 1**，应该立即看到：
```
event: notification
data: {"jsonrpc": "2.0", "method": "notifications/tools/list_changed"}
```

再次切换回 active：
```bash
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=active"
```

终端 1 应该再次收到通知。

---

## 5. 测试 MCP 协议方法

### 5.1 Initialize 请求
```bash
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {}
    },
    "id": 1
  }' | python3 -m json.tool
```

**期望结果**：
```json
{
    "jsonrpc": "2.0",
    "result": {
        "protocolVersion": "2024-11-05",
        "capabilities": {
            "tools": {
                "listChanged": true
            }
        },
        "serverInfo": {
            "name": "Synapse Test Server",
            "version": "0.4.0"
        }
    },
    "id": 1
}
```

### 5.2 获取工具列表
```bash
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "tools/list",
    "params": {},
    "id": 2
  }' | python3 -m json.tool
```

**期望结果**：返回工具列表，工具名称带 `synapse_` 前缀。

---

## 6. 测试完整流程（推荐）

### 步骤 1：建立 SSE 连接
终端 1：
```bash
curl -N http://localhost:8000/mcp/synapse/sse
```

### 步骤 2：测试协议方法
终端 2：
```bash
# Initialize
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{}},"id":1}' \
  | python3 -m json.tool

# 获取工具列表
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"tools/list","params":{},"id":2}' \
  | python3 -m json.tool
```

### 步骤 3：触发通知
终端 2：
```bash
# 更新 MCP Server（添加或删除组合）
curl -X PUT http://localhost:8000/api/v1/mcp-servers/1 \
  -H "Content-Type: application/json" \
  -d '{"combination_ids": [1]}' \
  | python3 -m json.tool
```

**检查终端 1** 是否收到通知。

---

## 7. Claude Desktop 客户端测试（可选）

### 配置文件位置
- macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
- Windows: `%APPDATA%\Claude\claude_desktop_config.json`

### 配置内容
```json
{
  "mcpServers": {
    "synapse": {
      "url": "http://localhost:8000/mcp/synapse",
      "sse": "http://localhost:8000/mcp/synapse/sse"
    }
  }
}
```

### 测试步骤
1. 打开配置文件，添加上述配置
2. **完全退出** Claude Desktop（不是最小化）
3. 重新启动 Claude Desktop
4. 打开开发者工具（如果有）查看是否连接成功
5. 在对话中尝试使用 Synapse 提供的工具

---

## 8. 故障排查

### 问题 1：SSE 连接无响应
**检查**：
```bash
lsof -i:8000  # 确认服务在运行
curl http://localhost:8000/api/v1/mcp-servers  # 确认 API 正常
```

### 问题 2：收不到通知
**检查**：
1. SSE 连接是否保持活跃
2. MCP Server 状态是否为 `active`
3. 后台日志是否有错误

### 问题 3：工具列表为空
**检查**：
```bash
# 检查组合是否存在
curl http://localhost:8000/api/v1/combinations

# 检查 MCP Server 的 combination_ids
curl http://localhost:8000/api/v1/mcp-servers/1
```

---

## 9. 关键验证点

测试时请确认以下几点：

✅ SSE 连接能成功建立并保持
✅ 配置变更时 SSE 客户端立即收到通知
✅ initialize 响应中包含 `listChanged: true`
✅ tools/list 返回正确的工具列表
✅ 工具名称使用 prefix 前缀
✅ 配置端点返回 HTTP + SSE 双端点

---

## 10. 测试完成后

如果所有测试通过，可以：

1. 查看测试报告：
   - `MCP_IMPLEMENTATION_REPORT.md` - 实现说明
   - `MCP_TEST_RESULTS.md` - 测试结果

2. 决定是否进行 git 提交

3. 部署到生产环境（需要额外配置 HTTPS、认证等）
