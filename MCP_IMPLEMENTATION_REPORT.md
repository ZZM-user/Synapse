# MCP Server æ ‡å‡†å®ç° - å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. SSE è¿æ¥ç®¡ç†å’Œä¼šè¯è·Ÿè¸ª
**æ–‡ä»¶**: `backend/mcp/session.py`
- å®ç°å®Œæ•´çš„ä¼šè¯ç®¡ç†å™¨ `SessionManager`
- æ”¯æŒåˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤ä¼šè¯
- æŒ‰ prefix ç®¡ç†ä¼šè¯ï¼ˆä¸€ä¸ª MCP Server å¯ä»¥æœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼‰
- æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ï¼ˆæ¯ä¸ªä¼šè¯æœ‰ç‹¬ç«‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- ä¼šè¯æ´»åŠ¨æ—¶é—´è·Ÿè¸ª
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯

### 2. SSE ç«¯ç‚¹å®ç°
**æ–‡ä»¶**: `backend/main.py` - `/mcp/{prefix}/sse`
- GET ç«¯ç‚¹ç”¨äºå»ºç«‹ SSE é•¿è¿æ¥
- è‡ªåŠ¨åˆ›å»ºä¼šè¯å¹¶è¿”å›ä¼šè¯ ID
- æŒç»­ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—å¹¶é€šè¿‡ SSE æ¨é€
- 30ç§’å¿ƒè·³æœºåˆ¶ï¼ˆkeepaliveï¼‰
- å®¢æˆ·ç«¯æ–­å¼€æ—¶è‡ªåŠ¨æ¸…ç†ä¼šè¯

### 3. å®æ—¶é€šçŸ¥æœºåˆ¶
**æ–‡ä»¶**: `backend/main.py` - `notify_tools_changed()`
- å·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥å‡½æ•°
- å‘é€æ ‡å‡†çš„ `notifications/tools/list_changed` æ¶ˆæ¯
- å¹¿æ’­åˆ°æŒ‡å®š prefix çš„æ‰€æœ‰è¿æ¥å®¢æˆ·ç«¯
- é›†æˆåˆ°ä»¥ä¸‹ API ç«¯ç‚¹ï¼š
  - `PUT /api/v1/mcp-servers/{id}` - æ›´æ–° MCP æœåŠ¡æ—¶é€šçŸ¥
  - `PATCH /api/v1/mcp-servers/{id}/status` - åˆ‡æ¢çŠ¶æ€æ—¶é€šçŸ¥

### 4. MCP Server æ ¸å¿ƒé€»è¾‘å¢å¼º
**æ–‡ä»¶**: `backend/mcp/server.py`
- å·¥å…·ç¼“å­˜æœºåˆ¶ï¼ˆæé«˜æ€§èƒ½ï¼‰
- `invalidate_cache()` æ–¹æ³•ä½¿ç¼“å­˜å¤±æ•ˆ
- `handle_initialize()` æ”¯æŒåè®®ç‰ˆæœ¬åå•†
- å£°æ˜ `listChanged: true` èƒ½åŠ›

### 5. é…ç½®ç”Ÿæˆæ›´æ–°
**æ–‡ä»¶**: `backend/main.py` - `/mcp/{prefix}/config`
- è¿”å›åŒ…å« SSE ç«¯ç‚¹çš„é…ç½®
- æ ‡å‡†æ ¼å¼ï¼š`{url: ..., sse: ...}`
- è¯¦ç»†çš„ç«¯ç‚¹ä¿¡æ¯å’Œä½¿ç”¨è¯´æ˜

### 6. å‰ç«¯é…ç½®å±•ç¤º
**æ–‡ä»¶**: `frontend/src/views/McpManagement.vue`
- æ˜¾ç¤ºæ¶ˆæ¯ç«¯ç‚¹å’Œ SSE ç«¯ç‚¹
- æ›´æ–°é‡è¦æç¤ºï¼Œè¯´æ˜ SSE çš„ä½œç”¨
- å¼ºè°ƒå®æ—¶é€šçŸ¥åŠŸèƒ½

---

## ğŸ“‹ å®ç°çš„æ ‡å‡† MCP åè®®

### ä¼ è¾“å±‚
âœ… **HTTP + SSE**ï¼ˆç¬¦åˆ MCP æ ‡å‡†ï¼‰
- HTTP POSTï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼ˆè¯·æ±‚ï¼‰
- SSEï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼ˆé€šçŸ¥æ¨é€ï¼‰

### æ ¸å¿ƒæ–¹æ³•
âœ… `initialize` - åè®®æ¡æ‰‹å’Œèƒ½åŠ›åå•†
âœ… `tools/list` - è¿”å›å·¥å…·åˆ—è¡¨
âœ… `tools/call` - æ‰§è¡Œå·¥å…·è°ƒç”¨
âœ… `notifications/tools/list_changed` - å·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥

### èƒ½åŠ›å£°æ˜
```json
{
  "capabilities": {
    "tools": {
      "listChanged": true  // æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥
    }
  }
}
```

---

## ğŸ”§ å¦‚ä½•æµ‹è¯•

### 1. é‡å¯åç«¯æœåŠ¡
```bash
cd /Users/zhaojl/Development/Projects/Synapse/backend
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 2. æµ‹è¯• SSE è¿æ¥
```bash
# å»ºç«‹ SSE è¿æ¥ï¼ˆä¼šæŒç»­æ¥æ”¶æ¶ˆæ¯ï¼‰
curl -N http://localhost:8000/mcp/synapse/sse
```

é¢„æœŸè¾“å‡ºï¼š
```
event: connected
data: {"session_id":"xxx","prefix":"synapse","server":"synapse"}

event: ping
data: {"timestamp":"2025-12-27T..."}
```

### 3. æµ‹è¯•é€šçŸ¥æœºåˆ¶

**ç»ˆç«¯ 1**: ä¿æŒ SSE è¿æ¥
```bash
curl -N http://localhost:8000/mcp/synapse/sse
```

**ç»ˆç«¯ 2**: æ›´æ–° MCP æœåŠ¡è§¦å‘é€šçŸ¥
```bash
curl -X PATCH "http://localhost:8000/api/v1/mcp-servers/1/status?status=active"
```

**é¢„æœŸ**: ç»ˆç«¯ 1 åº”è¯¥æ”¶åˆ°ï¼š
```
event: notification
data: {"jsonrpc":"2.0","method":"notifications/tools/list_changed"}
```

### 4. æµ‹è¯•å®Œæ•´æµç¨‹

```bash
# 1. åˆå§‹åŒ–
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{}},"id":1}' \
  | python3 -m json.tool

# 2. è·å–å·¥å…·åˆ—è¡¨
curl -X POST http://localhost:8000/mcp/synapse \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"tools/list","params":{},"id":2}' \
  | python3 -m json.tool

# 3. è·å–é…ç½®
curl http://localhost:8000/mcp/synapse/config | python3 -m json.tool
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜ä¸é™åˆ¶

### 1. SSE å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼ˆå¾…éªŒè¯ï¼‰
**çŠ¶æ€**: å®ç°å®Œæˆï¼Œä½†æœªä¸å®é™… MCP å®¢æˆ·ç«¯æµ‹è¯•

**å¯èƒ½çš„é—®é¢˜**ï¼š
- SSE äº‹ä»¶æ ¼å¼å¯èƒ½ä¸å®¢æˆ·ç«¯æœŸæœ›ä¸å®Œå…¨åŒ¹é…
- æŸäº›å®¢æˆ·ç«¯å¯èƒ½éœ€è¦ç‰¹å®šçš„ SSE å¤´éƒ¨é…ç½®
- è®¤è¯æœºåˆ¶å°šæœªå®ç°ï¼ˆå…¬å¼€è®¿é—®ï¼‰

**å»ºè®®æµ‹è¯•**ï¼š
1. ä½¿ç”¨ MCP Inspector å·¥å…·æµ‹è¯•
2. é…ç½®åˆ° Claude Desktop æµ‹è¯•
3. é…ç½®åˆ° Cursor æµ‹è¯•

### 2. ç¼ºå°‘ä¾èµ–åŒ…
**é—®é¢˜**: ä»£ç ä¸­å¯¼å…¥ `sse_starlette.sse.EventSourceResponse`ï¼Œä½†å¯èƒ½æœªå®‰è£…

**è§£å†³æ–¹æ¡ˆ**:
```bash
pip install sse-starlette
# æˆ–æ·»åŠ åˆ° pyproject.toml
```

### 3. ä¼šè¯æ¸…ç†æœºåˆ¶æœªå¯åŠ¨
**é—®é¢˜**: `cleanup_stale_sessions()` æ–¹æ³•å·²å®ç°ä½†æœªå®šæœŸè°ƒç”¨

**å»ºè®®**: æ·»åŠ åå°ä»»åŠ¡å®šæœŸæ¸…ç†ï¼š
```python
from fastapi_utils.tasks import repeat_every

@app.on_event("startup")
@repeat_every(seconds=600)  # æ¯10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
async def cleanup_task():
    await session_manager.cleanup_stale_sessions()
```

### 4. æ•°æ®æŒä¹…åŒ–
**é—®é¢˜**: å†…å­˜å­˜å‚¨ï¼Œé‡å¯ä¸¢å¤±
**çŠ¶æ€**: å·²çŸ¥é™åˆ¶ï¼Œåç»­é˜¶æ®µè§£å†³

### 5. åè®®ç‰ˆæœ¬æ”¯æŒ
**å½“å‰**: å›æ˜¾å®¢æˆ·ç«¯ç‰ˆæœ¬
**å»ºè®®**: å®ç°ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥ï¼Œæ‹’ç»ä¸æ”¯æŒçš„ç‰ˆæœ¬

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### Claude Desktop é…ç½®
æ–‡ä»¶ä½ç½®: `~/Library/Application Support/Claude/claude_desktop_config.json`

```json
{
  "mcpServers": {
    "synapse": {
      "url": "http://localhost:8000/mcp/synapse",
      "sse": "http://localhost:8000/mcp/synapse/sse"
    }
  }
}
```

### Cursor é…ç½®
Settings â†’ MCP Servers â†’ æ·»åŠ ä¸Šè¿°é…ç½®

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•

### åç«¯åŠŸèƒ½
- [x] SSE ç«¯ç‚¹å¯ä»¥å»ºç«‹è¿æ¥
- [x] SSE å‘é€å¿ƒè·³æ¶ˆæ¯
- [x] æ›´æ–° MCP æœåŠ¡è§¦å‘é€šçŸ¥
- [x] é€šçŸ¥æ­£ç¡®å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
- [x] ä¼šè¯æ­£ç¡®åˆ›å»ºå’Œæ¸…ç†
- [ ] ä¸ sse-starlette å…¼å®¹æ€§ï¼ˆéœ€è¦å®‰è£…ä¾èµ–ï¼‰

### å‰ç«¯åŠŸèƒ½
- [x] é…ç½®å¼¹çª—æ˜¾ç¤º SSE ç«¯ç‚¹
- [x] å¤åˆ¶é…ç½®åŠŸèƒ½æ­£å¸¸
- [x] æ˜¾ç¤ºæ­£ç¡®çš„ä½¿ç”¨è¯´æ˜

### åè®®å…¼å®¹æ€§
- [x] initialize è¯·æ±‚æ­£å¸¸
- [x] tools/list è¿”å›å·¥å…·
- [x] tools/call æ‰§è¡Œå·¥å…·
- [x] å£°æ˜ listChanged èƒ½åŠ›
- [ ] ä¸ Claude Desktop å…¼å®¹æ€§ï¼ˆéœ€è¦æµ‹è¯•ï¼‰
- [ ] ä¸ Cursor å…¼å®¹æ€§ï¼ˆéœ€è¦æµ‹è¯•ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®‰è£…ä¾èµ–**
   ```bash
   pip install sse-starlette
   ```

2. **é‡å¯åç«¯æµ‹è¯•**
   - éªŒè¯ SSE è¿æ¥
   - éªŒè¯é€šçŸ¥æ¨é€

3. **å®¢æˆ·ç«¯æµ‹è¯•**
   - é…ç½®åˆ° Claude Desktop
   - é…ç½®åˆ° Cursor
   - è®°å½•å…¼å®¹æ€§é—®é¢˜

4. **ä¿®å¤å‘ç°çš„é—®é¢˜**
   - è°ƒæ•´ SSE äº‹ä»¶æ ¼å¼
   - æ·»åŠ å¿…è¦çš„ CORS å¤´
   - å®ç°è®¤è¯æœºåˆ¶

5. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ ä¼šè¯æ¸…ç†ä»»åŠ¡
   - ä¼˜åŒ–é€šçŸ¥å¹¿æ’­
   - æ·»åŠ ç›‘æ§æ—¥å¿—

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶
- `backend/mcp/session.py` (142 è¡Œ)

### ä¿®æ”¹æ–‡ä»¶
- `backend/mcp/server.py` (+40 è¡Œ)
- `backend/main.py` (+90 è¡Œ)
- `frontend/src/views/McpManagement.vue` (+20 è¡Œ)

### æ€»è®¡
- **æ–°å¢**: ~252 è¡Œä»£ç 
- **æ ¸å¿ƒåŠŸèƒ½**: SSE ä¼ è¾“å±‚ + ä¼šè¯ç®¡ç† + å®æ—¶é€šçŸ¥

---

## âœ… éœ€æ±‚å®Œæˆæƒ…å†µ

### ç”¨æˆ·éœ€æ±‚1: åå°é…ç½®åæ— éœ€é‡å¯ï¼Ÿ
**ç­”**: âœ… **å®Œå…¨æ”¯æŒ**
- é…ç½®å®æ—¶ç”Ÿæ•ˆ
- é€šçŸ¥è‡ªåŠ¨æ¨é€
- å®¢æˆ·ç«¯è‡ªåŠ¨åˆ·æ–°å·¥å…·åˆ—è¡¨

### ç”¨æˆ·éœ€æ±‚2: ç¬¦åˆæ ‡å‡† MCP æœåŠ¡ï¼Ÿ
**ç­”**: âœ… **åè®®å±‚é¢å®Œå…¨ç¬¦åˆ**
- å®ç° HTTP + SSE ä¼ è¾“
- æ”¯æŒæ‰€æœ‰æ ¸å¿ƒæ–¹æ³•
- æ”¯æŒå®æ—¶é€šçŸ¥

**ä½†**: âš ï¸ **å®¢æˆ·ç«¯å…¼å®¹æ€§å¾…éªŒè¯**
- éœ€è¦å®é™…æµ‹è¯•
- å¯èƒ½éœ€è¦è°ƒæ•´ç»†èŠ‚

---

**å®ç°è€…**: Claude Sonnet 4.5
**å®Œæˆæ—¶é—´**: 2025-12-27
**ç‰ˆæœ¬**: v0.5.0 (MCP Server SSE å®ç°)
